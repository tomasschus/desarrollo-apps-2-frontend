name: Build & Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production # üëà Usar environment

    steps:
      # 1Ô∏è‚É£ Checkout del repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Mostrar informaci√≥n del release
      - name: Show release info
        run: |
          echo "üöÄ Deployando versi√≥n: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Autor: ${{ github.actor }}"

      # 3Ô∏è‚É£ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 22

      # 4Ô∏è‚É£ Instalar dependencias
      - name: Install dependencies
        run: npm ci

      # 5Ô∏è‚É£ Build de la app
      - name: Build app
        env:
          # Variables de entorno no sensibles (desde Environment Variables)
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_N8N_API_BASE_URL: ${{ vars.VITE_N8N_API_BASE_URL }}
          VITE_GRAPHHOPPER_URL: ${{ vars.VITE_GRAPHHOPPER_URL }}
          # Variables sensibles (desde Secrets)
          VITE_GRAPHHOPPER_API_KEY: ${{ secrets.VITE_GRAPHHOPPER_API_KEY }}
        run: npm run build

      # 6Ô∏è‚É£ Ejecutar tests:
      # - name: Run tests
      #   run: npm test

      # 7Ô∏è‚É£ Crear deploy.tar para CapRover (solo archivos built y config)
      - name: Create deploy.tar for CapRover
        run: |
          # Crear directorio temporal para el deploy
          mkdir -p deploy-package

          # Copiar solo los archivos necesarios
          cp -r dist deploy-package/
          cp Dockerfile.production deploy-package/Dockerfile
          cp captain-definition deploy-package/
          cp nginx.conf deploy-package/

          # Crear deploy.tar en la ra√≠z (nombre exacto que busca la acci√≥n)
          tar -C deploy-package -cf deploy.tar .

          echo "üì¶ Contenido del deploy.tar:"
          tar -tvf deploy.tar
          echo "üìè Tama√±o del tar:"
          ls -lh deploy.tar

      # 8Ô∏è‚É£ Deploy a CapRover
      - name: Deploy to CapRover
        uses: caprover/deploy-from-github@v1.1.2
        with:
          server: ${{ secrets.CAPROVER_SERVER }}
          app: ${{ secrets.APP_NAME }}
          token: ${{ secrets.APP_TOKEN }}
